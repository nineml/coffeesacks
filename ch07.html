<!DOCTYPE html><html xmlns="http://www.w3.org/1999/xhtml" class="no-js"><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><script>(function(H){H.className=H.className.replace(/\bno-js\b/,'js')})(document.documentElement)</script><title>Chapter 7. Choosing among alternatives</title><link href="/css/pygments.css" rel="stylesheet"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><link href="https://purl.org/dc/elements/1.1/" rel="schema.dc"/><meta name="dc.modified" content="2023-08-02T15:15:09Z"/><meta name="generator" content="DocBook xslTNG version 2.1.6 / cf0b935 / SAXON EE 12.3"/><link href="/css/docbook-toc.css" rel="stylesheet"/><link href="/css/docbook.css" rel="stylesheet" media="screen"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><script src="https://kit.fontawesome.com/498b6706f0.js" type="text/javascript" crossorigin="anonymous"></script><link href="icon/CoffeeSacks.png" rel="shortcut icon"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><link href="css/nineml.css" rel="stylesheet"/><link href="css/coffeesacks.css" rel="stylesheet"/><link rel="prev" href="ch06.html"/><link rel="next" href="appa.html"/><link rel="up" href="index.html"/><link rel="home" href="index.html"/><script src="/js/persistent-toc.js" defer="defer"></script><script src="/js/copy-verbatim.js" defer="defer"></script><script src="/js/chunk-nav.js" defer="defer"></script></head><body><nav class="top"><span class="nav"><a title="CoffeeSacks" href="index.html"><i class="fas fa-home"></i></a> <a href="ch06.html" title="Chapter  6 .  RegisterCoffeeSacks"><i class="fas fa-arrow-left"></i></a> <a title="CoffeeSacks" href="index.html"><i class="fas fa-arrow-up"></i></a> <a title="Appendix  A .  Unicode Character Classes" href="appa.html"><i class="fas fa-arrow-right"></i></a></span><span class="title"><i class="title">CoffeeSacks</i></span></nav><main><section id="choose-alternative" db-chunk="ch07.html" db-id="d108e478" class="chapter component"><header><h2>Chapter <span class="label">7</span><span class="sep">. </span>Choosing among alternatives</h2></header><div class="admonition note"><div><div class="icon">ⓘ</div><div class="body"><header><div class="title">Note</div></header><div><p>This API has been completely rewritten for version 3.0.0.</p></div></div></div></div><p>Where it’s practical to write a grammar that is unambiguous,
that’s best. But it isn’t always practical. Sometimes it’s difficult,
and sometimes it’s impossible. If the data is actually ambiguous, you
may have to reflect that in your grammar.</p><p>Invisible XML doesn’t consider ambiguity an error, but it also
doesn’t provide any mechanism for controlling it. All parses are
considered equal and the processor’s only obligation is to provide one
of them.</p><p>That may not suit your needs. CoffeeSacks provides a way to
examine the alternatives and select one. You can supply a
<code>choose-alternative</code> function in the parser options. This
must be a function that takes a single argument, a list of elements,
and returns an integer.</p><p>The function receives a context element that identifies its
location in the parse forest and a map that describes the current
state of the parse:</p><div id="choose-alternative_informaltable1" class="informalobject informaltable"><table><thead><tr><th>Property</th><th>Value</th></tr></thead><tbody><tr><td><code>input</code></td><td>The input string</td></tr><tr><td><code>available-choices</code></td><td>A list of available choices</td></tr><tr><td><code>other-choices</code></td><td>A list of other choices</td></tr><tr><td><em class="replaceable">user-defined</em></td><td>User defined properties</td></tr></tbody></table></div><p>The function must return a map that contains a <code>selection</code> property that
identifies the choice made. It may also return an <code>ambiguous-choice</code> property to
indicate that an abitrary, ambiguous choice was made.</p><p>Any other properties returned in the map will be passed back on the next call.
This allows the selection function to maintain state between invocations.</p><p>The function must return one of the choices passed to it. There will always be
at least one item in the <code>choices</code> list. The difference between the available
choices and the “other” choices is only relevant when the grammar contains a loop. If the
grammar loops, the previously selected choices will be in <code>other-choices</code>.
Only choose from that list if you have some other way to avoid looping infinitely.</p><p>This function always selects the first alternative:</p><div class="pre-wrap highlight" db-startinglinenumber="1" db-numberoflines="6"><pre class="language-xml long numbered programlisting verbatim verblines"><span class="line" db-line="1"><span class="ln">1 <span class="nsep">|</span></span><span class="ld"><code><span class="nt">&lt;xsl:function</span> <span class="na">name=</span><span class="s">"f:first"</span> <span class="na">as=</span><span class="s">"map(*)"</span><span class="nt">&gt;</span></code></span></span>
<span class="line" db-line="2"><span class="ln">  <span class="nsep">|</span></span><span class="ld"><code>  <span class="nt">&lt;xsl:param</span> <span class="na">name=</span><span class="s">"context"</span> <span class="na">as=</span><span class="s">"element()"</span><span class="nt">/&gt;</span></code></span></span>
<span class="line" db-line="3"><span class="ln">  <span class="nsep">|</span></span><span class="ld"><code>  <span class="nt">&lt;xsl:param</span> <span class="na">name=</span><span class="s">"options"</span> <span class="na">as=</span><span class="s">"map(*)"</span><span class="nt">/&gt;</span></code></span></span>
<span class="line" db-line="4"><span class="ln">  <span class="nsep">|</span></span><span class="ld"><code> </code></span></span>
<span class="line" db-line="5"><span class="ln">5 <span class="nsep">|</span></span><span class="ld"><code>  <span class="nt">&lt;xsl:sequence</span> <span class="na">select=</span><span class="s">"map { 'selection': $options?available-choices[1] }"</span><span class="nt">/&gt;</span></code></span></span>
<span class="line" db-line="6"><span class="ln">  <span class="nsep">|</span></span><span class="ld"><code><span class="nt">&lt;/xsl:function&gt;</span></code></span></span>
</pre></div><p>You could pass it in parse options like this:</p><div class="pre-wrap highlight" db-startinglinenumber="1" db-numberoflines="3"><pre class="language-xml numbered programlisting verbatim verblines"><span class="line" db-line="1"><span class="ln">  <span class="nsep">|</span></span><span class="ld"><code><span class="nt">&lt;xsl:variable</span> <span class="na">name=</span><span class="s">"parser"</span></code></span></span>
<span class="line" db-line="2"><span class="ln">  <span class="nsep">|</span></span><span class="ld"><code>              <span class="na">select=</span><span class="s">"cs:make-parser($grammar,</span></code></span></span>
<span class="line" db-line="3"><span class="ln">  <span class="nsep">|</span></span><span class="ld"><code><span class="s">                      map{'choose-alternative: f:first#2})"</span><span class="nt">/&gt;</span></code></span></span>
</pre></div><p>Of course, unconditionally choosing the first option isn’t very
interesting. To explore further, consider this simple, ambiguous
grammar:</p><div class="pre-wrap" db-startinglinenumber="1" db-numberoflines="6"><pre class="language-ixml long numbered programlisting verbatim verblines"><span class="line" db-line="1"><span class="ln">1 <span class="nsep">|</span></span><span class="ld"><code>   number-list = (number, -#a)+, number? .</code></span></span>
<span class="line" db-line="2"><span class="ln">  <span class="nsep">|</span></span><span class="ld"><code>        number = hex | decimal .</code></span></span>
<span class="line" db-line="3"><span class="ln">  <span class="nsep">|</span></span><span class="ld"><code>           hex = hex-digit+ .</code></span></span>
<span class="line" db-line="4"><span class="ln">  <span class="nsep">|</span></span><span class="ld"><code>       decimal = decimal-digit+ .</code></span></span>
<span class="line" db-line="5"><span class="ln">5 <span class="nsep">|</span></span><span class="ld"><code>    -hex-digit = ["0"-"9" | "a"-"f" | "A"-"F" ] .</code></span></span>
<span class="line" db-line="6"><span class="ln">  <span class="nsep">|</span></span><span class="ld"><code>-decimal-digit = ["0"-"9" ] .</code></span></span>
</pre></div><p>If we parse the following input,</p><div class="pre-wrap" db-startinglinenumber="1" db-numberoflines="3"><pre class="language-none numbered programlisting verbatim verblines"><span class="line" db-line="1"><span class="ln">  <span class="nsep">|</span></span><span class="ld"><code>bad</code></span></span>
<span class="line" db-line="2"><span class="ln">  <span class="nsep">|</span></span><span class="ld"><code>cafe</code></span></span>
<span class="line" db-line="3"><span class="ln">  <span class="nsep">|</span></span><span class="ld"><code>42</code></span></span>
</pre></div><p>We might get this result:</p><div class="pre-wrap highlight" db-startinglinenumber="1" db-numberoflines="5"><pre class="language-xml long numbered programlisting verbatim verblines"><span class="line" db-line="1"><span class="ln">1 <span class="nsep">|</span></span><span class="ld"><code><span class="nt">&lt;number-list</span> <span class="na">xmlns:ixml=</span><span class="s">"http://invisiblexml.org/NS"</span> <span class="na">ixml:state=</span><span class="s">"ambiguous"</span><span class="nt">&gt;</span></code></span></span>
<span class="line" db-line="2"><span class="ln">  <span class="nsep">|</span></span><span class="ld"><code>  <span class="nt">&lt;hex&gt;</span>bad<span class="nt">&lt;/hex&gt;</span></code></span></span>
<span class="line" db-line="3"><span class="ln">  <span class="nsep">|</span></span><span class="ld"><code>  <span class="nt">&lt;hex&gt;</span>cafe<span class="nt">&lt;/hex&gt;</span></code></span></span>
<span class="line" db-line="4"><span class="ln">  <span class="nsep">|</span></span><span class="ld"><code>  <span class="nt">&lt;hex&gt;</span>42<span class="nt">&lt;/hex&gt;</span></code></span></span>
<span class="line" db-line="5"><span class="ln">5 <span class="nsep">|</span></span><span class="ld"><code><span class="nt">&lt;/number-list&gt;</span></code></span></span>
</pre></div><p>Of course, we might equally get this result:</p><div class="pre-wrap highlight" db-startinglinenumber="1" db-numberoflines="5"><pre class="language-xml long numbered programlisting verbatim verblines"><span class="line" db-line="1"><span class="ln">1 <span class="nsep">|</span></span><span class="ld"><code><span class="nt">&lt;number-list</span> <span class="na">xmlns:ixml=</span><span class="s">"http://invisiblexml.org/NS"</span> <span class="na">ixml:state=</span><span class="s">"ambiguous"</span><span class="nt">&gt;</span></code></span></span>
<span class="line" db-line="2"><span class="ln">  <span class="nsep">|</span></span><span class="ld"><code>  <span class="nt">&lt;hex&gt;</span>bad<span class="nt">&lt;/hex&gt;</span></code></span></span>
<span class="line" db-line="3"><span class="ln">  <span class="nsep">|</span></span><span class="ld"><code>  <span class="nt">&lt;hex&gt;</span>cafe<span class="nt">&lt;/hex&gt;</span></code></span></span>
<span class="line" db-line="4"><span class="ln">  <span class="nsep">|</span></span><span class="ld"><code>  <span class="nt">&lt;decimal&gt;</span>42<span class="nt">&lt;/decimal&gt;</span></code></span></span>
<span class="line" db-line="5"><span class="ln">5 <span class="nsep">|</span></span><span class="ld"><code><span class="nt">&lt;/number-list&gt;</span></code></span></span>
</pre></div><p>The ambiguity here is between “decimal” and “hexidecimal”.
Here’s a function that will always select the decimal alternative:
</p><div class="pre-wrap highlight" db-startinglinenumber="1" db-numberoflines="9"><pre class="language-xml long numbered programlisting verbatim verblines"><span class="line" db-line="1"><span class="ln">1 <span class="nsep">|</span></span><span class="ld"><code><span class="nt">&lt;xsl:function</span> <span class="na">name=</span><span class="s">"f:choose"</span> <span class="na">as=</span><span class="s">"map(*)"</span><span class="nt">&gt;</span></code></span></span>
<span class="line" db-line="2"><span class="ln">  <span class="nsep">|</span></span><span class="ld"><code>  <span class="nt">&lt;xsl:param</span> <span class="na">name=</span><span class="s">"context"</span> <span class="na">as=</span><span class="s">"element()"</span><span class="nt">/&gt;</span></code></span></span>
<span class="line" db-line="3"><span class="ln">  <span class="nsep">|</span></span><span class="ld"><code>  <span class="nt">&lt;xsl:param</span> <span class="na">name=</span><span class="s">"options"</span> <span class="na">as=</span><span class="s">"map(*)"</span><span class="nt">/&gt;</span></code></span></span>
<span class="line" db-line="4"><span class="ln">  <span class="nsep">|</span></span><span class="ld"><code> </code></span></span>
<span class="line" db-line="5"><span class="ln">5 <span class="nsep">|</span></span><span class="ld"><code>  <span class="nt">&lt;xsl:variable</span> <span class="na">name=</span><span class="s">"choice"</span></code></span></span>
<span class="line" db-line="6"><span class="ln">  <span class="nsep">|</span></span><span class="ld"><code>                <span class="na">select=</span><span class="s">"$context/children[symbol[@name='decimal']]/@id"</span><span class="nt">/&gt;</span></code></span></span>
<span class="line" db-line="7"><span class="ln">  <span class="nsep">|</span></span><span class="ld"><code> </code></span></span>
<span class="line" db-line="8"><span class="ln">  <span class="nsep">|</span></span><span class="ld"><code>  <span class="nt">&lt;xsl:sequence</span> <span class="na">select=</span><span class="s">"map { 'selection': $choice }"</span><span class="nt">/&gt;</span></code></span></span>
<span class="line" db-line="9"><span class="ln">  <span class="nsep">|</span></span><span class="ld"><code><span class="nt">&lt;/xsl:function&gt;</span></code></span></span>
</pre></div><p>In order to understand how this works, we need to look at what’s
passed to the function. The function get’s a context element that is
an XML description of the current state of the parse, and a map. For
our example, the map would look something like this:</p><div class="pre-wrap" db-startinglinenumber="1" db-numberoflines="7"><pre class="language-none long numbered programlisting verbatim verblines"><span class="line" db-line="1"><span class="ln">1 <span class="nsep">|</span></span><span class="ld"><code>map {</code></span></span>
<span class="line" db-line="2"><span class="ln">  <span class="nsep">|</span></span><span class="ld"><code>  "input":"bad</code></span></span>
<span class="line" db-line="3"><span class="ln">  <span class="nsep">|</span></span><span class="ld"><code>cafe</code></span></span>
<span class="line" db-line="4"><span class="ln">  <span class="nsep">|</span></span><span class="ld"><code>42",</code></span></span>
<span class="line" db-line="5"><span class="ln">5 <span class="nsep">|</span></span><span class="ld"><code>  "available-choices": ("C3464","C3465"),</code></span></span>
<span class="line" db-line="6"><span class="ln">  <span class="nsep">|</span></span><span class="ld"><code>  "other-choices":()</code></span></span>
<span class="line" db-line="7"><span class="ln">  <span class="nsep">|</span></span><span class="ld"><code>}</code></span></span>
</pre></div><p>And the context element like this:</p><div class="pre-wrap highlight" db-startinglinenumber="1" db-numberoflines="9"><pre class="language-xml long numbered programlisting verbatim verblines"><span class="line" db-line="1"><span class="ln">1 <span class="nsep">|</span></span><span class="ld"><code><span class="nt">&lt;symbol</span> <span class="na">name=</span><span class="s">"number"</span> <span class="na">id=</span><span class="s">"N3694"</span> <span class="na">mark=</span><span class="s">"^"</span> <span class="na">start=</span><span class="s">"10"</span> <span class="na">length=</span><span class="s">"2"</span><span class="nt">&gt;</span></code></span></span>
<span class="line" db-line="2"><span class="ln">  <span class="nsep">|</span></span><span class="ld"><code>   <span class="nt">&lt;parent</span> <span class="na">ref=</span><span class="s">"N3695"</span><span class="nt">&gt;</span>$4_number-option<span class="nt">&lt;/parent&gt;</span></code></span></span>
<span class="line" db-line="3"><span class="ln">  <span class="nsep">|</span></span><span class="ld"><code>   <span class="nt">&lt;children</span> <span class="na">id=</span><span class="s">"C3464"</span> <span class="na">priority=</span><span class="s">"0"</span><span class="nt">&gt;</span></code></span></span>
<span class="line" db-line="4"><span class="ln">  <span class="nsep">|</span></span><span class="ld"><code>      <span class="nt">&lt;symbol</span> <span class="na">name=</span><span class="s">"hex"</span> <span class="na">ref=</span><span class="s">"N3692"</span> <span class="na">start=</span><span class="s">"10"</span> <span class="na">length=</span><span class="s">"2"</span><span class="nt">/&gt;</span></code></span></span>
<span class="line" db-line="5"><span class="ln">5 <span class="nsep">|</span></span><span class="ld"><code>   <span class="nt">&lt;/children&gt;</span></code></span></span>
<span class="line" db-line="6"><span class="ln">  <span class="nsep">|</span></span><span class="ld"><code>   <span class="nt">&lt;children</span> <span class="na">id=</span><span class="s">"C3465"</span> <span class="na">priority=</span><span class="s">"0"</span><span class="nt">&gt;</span></code></span></span>
<span class="line" db-line="7"><span class="ln">  <span class="nsep">|</span></span><span class="ld"><code>      <span class="nt">&lt;symbol</span> <span class="na">name=</span><span class="s">"decimal"</span> <span class="na">ref=</span><span class="s">"N3693"</span> <span class="na">start=</span><span class="s">"10"</span> <span class="na">length=</span><span class="s">"2"</span><span class="nt">/&gt;</span></code></span></span>
<span class="line" db-line="8"><span class="ln">  <span class="nsep">|</span></span><span class="ld"><code>   <span class="nt">&lt;/children&gt;</span></code></span></span>
<span class="line" db-line="9"><span class="ln">  <span class="nsep">|</span></span><span class="ld"><code><span class="nt">&lt;/symbol&gt;</span></code></span></span>
</pre></div><p>This is a choice being made for the symbol “number”. There are
two choices, identified by “children”. In this example, each of the
alternatives is a single symbol, but the context can be more complex.
For each symbol, we also get the range of characters that it covers in
the input. For each choice, it’s computed priority. The context is
always the specific choice that’s being made, but the whole forest is
available. Each of the “N” references can be used to find the
corresponding nodes for those symbols.</p><p>Which aspects of the context (if any) are relevant is going to
depend on your grammar and the input.</p><section id="grammar-details" class="section"><header><h2><span class="label">7<span class="sep">.</span>1</span><span class="sep">. </span>Grammar details</h2></header><p>Invisible XML is an example of an
<a href="https://en.wikipedia.org/wiki/Extended_Backus%E2%80%93Naur_form" class="link">extended
Backus-Naur form</a> (EBNF) grammar. The underlying parsing technlogies, either Earley or GLL, operate
on simple <a href="https://en.wikipedia.org/wiki/Backus%E2%80%93Naur_form" class="link">Backus-Naur
form</a> (BNF) grammars. What that means in practice is that the first thing
<a href="https://coffeegrinder.nineml.org" class="link">CoffeeGrinder</a> does to your Invisible
XML grammar is
<a href="https://github.com/invisibleXML/ixml/blob/master/misc/ebnf-to-bnf.md" class="link">convert it</a>
into a plain BNF. That process introduces new nonterminals.</p><p>Mostly this is a behind-the-scenes transformation that isn’t
relevant to the user, but it’s inescapable when describing ambiguity.
Ultimately, the ambiguity is in the BNF and that’s the only grammar
that the parser can describe.</p><p>The oddly named nonterminals seen above come from the fact that
our iXML grammar has been transformed into this BNF:</p><div class="pre-wrap" db-startinglinenumber="1" db-numberoflines="16"><pre class="language-none long numbered programlisting verbatim verblines"><span class="line" db-line="1"><span class="ln"> 1 <span class="nsep">|</span></span><span class="ld"><code>                   $$ ::= number-list</code></span></span>
<span class="line" db-line="2"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code>          number-list ::= $1_number-plus, $4_number-optionⁿ</code></span></span>
<span class="line" db-line="3"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code>               number ::= hex</code></span></span>
<span class="line" db-line="4"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code>               number ::= decimal</code></span></span>
<span class="line" db-line="5"><span class="ln"> 5 <span class="nsep">|</span></span><span class="ld"><code>                  hex ::= $2_hex-digit-plus</code></span></span>
<span class="line" db-line="6"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code>              decimal ::= $3_decimal-digit-plus</code></span></span>
<span class="line" db-line="7"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code>            hex-digit ::= ['0'-'9'; 'a'-'f'; 'A'-'F']</code></span></span>
<span class="line" db-line="8"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code>        decimal-digit ::= ['0'-'9']</code></span></span>
<span class="line" db-line="9"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code>       $1_number-plus ::= number, #A</code></span></span>
<span class="line" db-line="10"><span class="ln">10 <span class="nsep">|</span></span><span class="ld"><code>       $1_number-plus ::= number, #A, $1_number-plus</code></span></span>
<span class="line" db-line="11"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code>    $2_hex-digit-plus ::= hex-digit</code></span></span>
<span class="line" db-line="12"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code>    $2_hex-digit-plus ::= hex-digit, $2_hex-digit-plus</code></span></span>
<span class="line" db-line="13"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code>$3_decimal-digit-plus ::= decimal-digit</code></span></span>
<span class="line" db-line="14"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code>$3_decimal-digit-plus ::= decimal-digit, $3_decimal-digit-plus</code></span></span>
<span class="line" db-line="15"><span class="ln">15 <span class="nsep">|</span></span><span class="ld"><code>    $4_number-optionⁿ ::= ε</code></span></span>
<span class="line" db-line="16"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code>    $4_number-optionⁿ ::= number</code></span></span>
</pre></div><p>This grammar is simpler in the sense that the rules for matching
tokens in the input are simpler. There are no repetitions,
alternatives, or other features on the “right hand side” of each production.</p><p>It appears more complicated partly because there are more
productions and there can be multiple productions for any given
nonterminal. It also appears more complicated because it’s impossible
to generate semantically meaningful names for the new nonterminals introduced.</p></section></section></main><nav class="bottom"><div class="navrow"><div class="navleft"><a title="Chapter  6 .  RegisterCoffeeSacks" href="ch06.html"><i class="fas fa-arrow-left"></i></a></div><div class="navmiddle"><a title="CoffeeSacks" href="index.html"><i class="fas fa-home"></i></a></div><div class="navright"><a title="Appendix  A .  Unicode Character Classes" href="appa.html"><i class="fas fa-arrow-right"></i></a></div></div><div class="navrow"><div class="navleft navtitle">Chapter  6 .  RegisterCoffeeSacks</div><div class="navmiddle"><a title="CoffeeSacks" href="index.html"><i class="fas fa-arrow-up"></i></a></div><div class="navright navtitle">Appendix  A .  Unicode Character Classes</div></div><div class="infofooter"><span class="copyrightfooter">Copyright © 2022–2023 Norman Walsh.</span></div><nav class="tocopen"></nav><nav class="toc"></nav><!-- Hide ToC details from user agents that don’t support JS --><script type="text/html" class="tocopen"><i class="far fa-book"></i></script><script type="text/html" class="toc"><header><span>Table of Contents</span><span class="close"><i class="far fa-window-close"></i></span><p class="ptoc-search"><input class="ptoc-search" placeholder="Search" style="width: 80%"/></p></header><div db-persistent-toc="persistent-toc.html" db-prefix="">Loading…</div></script></nav></body></html>